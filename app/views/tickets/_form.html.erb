<%= form_with model: @ticket, html: { class: 'card p-3' } do |f| %>
  <!-- Action Dropdown - Top Right -->
  <div class="d-flex justify-content-end mb-3">
    <div class="dropdown">
      <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
        <i class="fas fa-ellipsis-v"></i>
      </button>
      <ul class="dropdown-menu dropdown-menu-end">
        <li>
          <button type="button" class="dropdown-item" onclick="document.getElementById('submit-btn').click();" style="border: none; background: none; width: 100%; text-align: left;">
            <i class="fas fa-save me-2"></i>Save Ticket
          </button>
        </li>
        <li><hr class="dropdown-divider"></li>
        <li>
          <% if @company.present? %>
            <%= link_to 'Cancel', company_path(@company), class: 'dropdown-item' %>
          <% else %>
            <%= link_to 'Cancel', tickets_path, class: 'dropdown-item' %>
          <% end %>
        </li>
      </ul>
    </div>
  </div>

  <!-- Show company context if creating from company -->
  <% if @company.present? %>
    <div class="alert alert-info mb-3">
      <strong>Creating ticket for:</strong> <%= @company.name %>
    </div>
  <% end %>

  <div class="row g-3">
    <!-- Hidden company_id field for redirect logic -->
    <% if @company.present? %>
      <%= hidden_field_tag :company_id, @company.id %>
    <% elsif params[:company_id].present? %>
      <%= hidden_field_tag :company_id, params[:company_id] %>
    <% end %>

    <div class="col-md-6">
      <%= f.label :contact_id, class: 'form-label' %>
      <%= f.select :contact_id,
          options_from_collection_for_select(@contacts, :id, :display_name_with_company, @ticket.contact_id),
          { prompt: 'Select a contact...' },
          { class: 'form-select', required: true } %>
      <% if @company.present? %>
        <small class="form-text text-muted">Only contacts from <%= @company.name %> are shown</small>
      <% end %>
    </div>
    <div class="col-md-6">
      <%= f.label :user_id, class: 'form-label' %>
      <%= f.hidden_field :user_id %>
      <input type="text" class="form-control" value="<%= @ticket.user&.name || current_user&.name || 'Unknown' %>" readonly>
    </div>
    <div class="col-md-6">
      <%= f.label :subject, class: 'form-label' %>
      <%= f.text_field :subject, class: 'form-control' %>
    </div>
    <div class="col-md-6">
      <%= f.label :issue, class: 'form-label' %>
      <%= f.text_field :issue, class: 'form-control' %>
    </div>
    <div class="col-12">
      <%= f.label :description, class: 'form-label' %>
      <%= f.text_area :description, class: 'form-control', rows: 3 %>
    </div>
    <div class="col-12">
      <%= f.label :note, class: 'form-label' %>
      <%= f.text_area :note, class: 'form-control', rows: 3 %>
    </div>
    <div class="col-md-6">
      <%= f.label :assigned_to, class: 'form-label' %>
      <%= f.text_field :assigned_to, class: 'form-control' %>
    </div>
    <div class="col-md-6">
      <%= f.label :status, class: 'form-label' %>
      <%= f.select :status, Ticket::STATUSES, {}, class: 'form-select' %>
    </div>
    <div class="col-md-6">
      <%= f.label :priority, class: 'form-label' %>
      <%= f.select :priority, Ticket::PRIORITIES, {}, class: 'form-select' %>
    </div>
  </div>

  <!-- Hidden submit button for dropdown action -->
  <%= f.submit 'Save Ticket', id: 'submit-btn', style: 'display: none;' %>

<% end %>
